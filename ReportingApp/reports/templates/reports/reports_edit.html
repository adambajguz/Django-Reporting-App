{% extends "base_reports_quickactions.html" %}

{% load custom_tags %}
{% load widget_tweeks %}

{% block breadcrumbs %}
	{{ block.super }} Â» Edit Report
{% endblock %}

{% block cotainer_start %} 

	<form class="uk-form" method="post" name="edit_form" action="{% url 'reports_edit' id=report.id %}">
		{% csrf_token %}

{% endblock %}

{% block cotainer_end %} 
	</form>
{% endblock %}

{% block quick_actions %}
	{% for field in report_form.visible_fields %}
	<div class="uk-form-row">
		<label class="uk-form-label" for="{{ field.name }}">{{ field.label_tag|safe }}</label>

		{% if field.errors %}
		<div class="uk-alert uk-alert-danger">{{ field.errors.as_text }}</div>
		{% endif %}

		<div class="uk-form-controls">
			{{ field }}
			<p class="uk-form-help-block"><em>{{ field.help_text }}</em></p>
		</div>
	</div>
	{% endfor %}

	<p>Last modification: {{ report.report_last_modification }}</p>

	<hr style="color: #CCE6FF; border-color: #CCE6FF; background-color: #CCE6FF;">

	<p>Columns properties:</p>
	<div class="uk-panel uk-panel-box" style="max-height: 190px; overflow-y: scroll;">
		<dl class="uk-description-list-line">
			{% for column in columns %}
				<dt><em>{{ column.column_name }}</em></dt>
				<dd>
					<b>Use as: </b>
					<label>
						<input type="checkbox" name="data_col" value="{{ column.id }}" {% if column.id in data_columns %}checked{% endif %}>
						data source, 
					</label>
					<label>
						<input type="checkbox" name="grouping_col" value="{{ column.id }}" {% if column.id in grouping_columns %}checked{% endif %}>
						grouping
					</label>
				</dd>
			{% endfor %}
		</dl>
	</div>

	<hr style="color: #CCE6FF; border-color: #CCE6FF; background-color: #CCE6FF;">

	<button name="delete" value="Delete" class="uk-margin-bottom uk-button uk-button-danger"><i class="uk-icon-trash"></i> Delete plot</button>
	<button class="uk-margin-bottom uk-button uk-button-primary"><i class="uk-icon-save"></i> Save</button>
{% endblock %}

{% block content %}

<div class="uk-width-1-1">

		{{ report_element_formset.management_form }}

		<div class="uk-form uk-form-stacked">
			{% if report_element_formset.non_form_errors %}
				{% for error in report_element_formset.non_form_errors %}
					{{ error|escape }}
				{% endfor %}
			{% endif %}

			{% for element in report_element_formset %}
				<div class="formset">
					<div class="uk-form-row">
						{% if element.element_name.errors %}
							<div class="uk-alert uk-alert-danger">
								{% for error in element.element_name.errors %}
									{{ error|escape }}
								{% endfor %}
							</div>
						{% endif %}
						
						<div class="uk-form-label" for="{{ element.element_name.name }}">{{ element.element_name.label_tag|safe }}</div>

						<div class="uk-form-controls">
							{{ element.element_name }}
						</div>
					</div>
		
					<div class="uk-form-row">
						{% if element.element_order.errors %}
							<div class="uk-alert uk-alert-danger">
								{% for error in element.element_order.errors %}
									{{ error|escape }}
								{% endfor %}
							</div>
						{% endif %}

						<div class="uk-form-label" for="{{ element.element_order.name }}">{{ element.element_order.label_tag|safe }}</div>

						<div class="uk-form-controls">
							{{ element.element_order }}
						</div>
					</div>

					<div class="uk-form-row">
						<div class="uk-form-label" for="{{ element.element_order.name }}">{{ element.element_order.label_tag|safe }}</div>

						<div class="uk-form-controls">
							{{ element.element_type }}
						</div>
					</div>

					<div id="element-text">
						<div class="uk-form-row">
							<div class="uk-form-label" for="{{ element.text.name }}">{{ element.text.label_tag|safe }}</div>

							<div class="uk-form-controls">
								{{ element.text }}
							</div>
						</div>
					</div>

					<div class="uk-form-row">
						<div class="uk-form-label" for="{{ element.caption.name }}">{{ element.caption.label_tag|safe }}</div>

						<div class="uk-form-controls">
							{{ element.caption }}
						</div>
					</div>

					<div class="uk-form-row">
						<div class="uk-form-label" for="{{ element.style.name }}">{{ element.style.label_tag|safe }}</div>

						<div class="uk-form-controls">
							{{ element.style }}
						</div>
					</div>
					
					<div class="uk-form-row">
						<div class="uk-form-label" for="{{ element.caption.name }}">{{ element.spreadsheet.label_tag|safe }}</div>

						<div class="uk-form-controls">
							{{ element.spreadsheet }}
						</div>
					</div>

					<div class="uk-form-row">
						<div class="uk-form-label" for="{{ element.columns.name }}">{{ element.columns.label_tag|safe }}</div>

						<div class="uk-form-controls">
							{{ element.columns }}
						</div>
					</div>

					<div class="uk-form-row">
						<div class="uk-form-label" for="{{ element.plot.name }}">{{ element.plot.label_tag|safe }}</div>

						<div class="uk-form-controls">
							{{ element.plot }}
						</div>
					</div>

					<div class="uk-form-row">
						<div class="uk-form-label" for="{{ element.embedded_raport.name }}">{{ element.embedded_raport.label_tag|safe }}</div>

						<div class="uk-form-controls">
							{{ element.embedded_raport }}
						</div>
					</div>

					<div class="uk-form-row">
						<div class="uk-form-label" for="{{ element.element_start.name }}">{{ element.element_start.label_tag|safe }}</div>

						<div class="uk-form-controls">
							{{ element.element_start }}
						</div>
					</div>

					<div class="uk-form-row">
						<div class="uk-form-label" for="{{ element.element_end.name }}">{{ element.element_end.label_tag|safe }}</div>

						<div class="uk-form-controls">
							{{ element.element_end }}
						</div>
					</div>
				</div>
				<hr>
			{% endfor %}
		</div>

</div>

<script>
		/* Fire an event handler to the specified node. Event handlers can detect that the event was fired programatically
		* by testing for a 'synthetic=true' property on the event object
		* @param {HTMLNode} node The node to fire the event handler on.
		* @param {String} eventName The name of the event without the "on" (e.g., "focus")
		*/
	   function fireEvent(node, eventName) {
		   // Make sure we use the ownerDocument from the provided node to avoid cross-window problems
		   var doc;
		   if (node.ownerDocument) {
			   doc = node.ownerDocument;
		   } else if (node.nodeType == 9){
			   // the node may be the document itself, nodeType 9 = DOCUMENT_NODE
			   doc = node;
		   } else {
			   throw new Error("Invalid node passed to fireEvent: " + node.id);
		   }
	   
			if (node.dispatchEvent) {
			   // Gecko-style approach (now the standard) takes more work
			   var eventClass = "";
	   
			   // Different events have different event classes.
			   // If this switch statement can't map an eventName to an eventClass,
			   // the event firing is going to fail.
			   switch (eventName) {
				   case "click": // Dispatching of 'click' appears to not work correctly in Safari. Use 'mousedown' or 'mouseup' instead.
				   case "mousedown":
				   case "mouseup":
					   eventClass = "MouseEvents";
					   break;
	   
				   case "focus":
				   case "change":
				   case "blur":
				   case "select":
					   eventClass = "HTMLEvents";
					   break;
	   
				   default:
					   throw "fireEvent: Couldn't find an event class for event '" + eventName + "'.";
					   break;
			   }
			   var event = doc.createEvent(eventClass);
			   event.initEvent(eventName, true, true); // All events created as bubbling and cancelable.
	   
			   event.synthetic = true; // allow detection of synthetic events
			   // The second parameter says go ahead with the default action
			   node.dispatchEvent(event, true);
		   } else  if (node.fireEvent) {
			   // IE-old school style, you can drop this if you don't need to support IE8 and lower
			   var event = doc.createEventObject();
			   event.synthetic = true; // allow detection of synthetic events
			   node.fireEvent("on" + eventName, event);
		   }
	   };

	function onCreate(row) {
		$('[data-onload]').each(function(){
			fireEvent($(this), "onchange");
		});
	}

	$('[data-onload]').each(function(){
		fireEvent(this, "onload");
	});

	$('.formset').formset({
		addText: 'add element',
		deleteText: 'remove',
		added: onCreate,
	});



	function showOrHide(el, el_show) {
		var el_label = $('label[for=' + el.id + ']');
		if(el_show === true) {
			el.style.display = "block";
			$(el.parentElement).show();
			el_label.show();
			$(el.parentElement).show();
			$(el.parentElement.parentElement).show();
		} else {
			el.style.display = "none";
			$(el.parentElement).hide();
			el_label.hide();
			$(el_label.parentElement).hide();
			$(el.parentElement.parentElement).hide();
		}
	}

	function myFunction(e) {
		console.log("ONLOAD");
		console.log(e)
		var selected = e.target.value;
		var selected_id = e.target.id.match(/\d+/)[0]

		var text = document.getElementById("id_form-" + selected_id + "-text");

		var caption = document.getElementById("id_form-" + selected_id + "-caption");

		var style = document.getElementById("id_form-" + selected_id + "-style");
		var spreadsheet = document.getElementById("id_form-" + selected_id + "-spreadsheet");
		var columns = document.getElementById("id_form-" + selected_id + "-columns");

		var plot = document.getElementById("id_form-" + selected_id + "-plot");

		var embedded_raport = document.getElementById("id_form-" + selected_id + "-embedded_raport");
		var element_start = document.getElementById("id_form-" + selected_id + "-element_start");
		var element_end = document.getElementById("id_form-" + selected_id + "-element_end");

		console.log()

		var text_show = false;
		var caption_show = false;
		var style_show = false;
		var spreadsheet_show = false;
		var columns_show = false;
		var plot_show = false;
		var embedded_raport_show = false;
		var element_start_show = false;
		var element_end_show = false;

		if (selected === "X") {
			text_show = true;
		} else if (selected === "T") {
			caption_show = true;
			spreadsheet_show = true;
			style_show = true;
			columns_show = true;
		} else if (selected === "P") {
			caption_show = true;
			plot_show = true;
		} else if (selected === "R") {
			embedded_raport_show = true;
			element_start_show = true;
			element_end_show = true;
		}

		showOrHide(text, text_show);
		showOrHide(caption, caption_show);
		showOrHide(style, style_show);
		showOrHide(spreadsheet, spreadsheet_show);
		showOrHide(columns, columns_show);
		showOrHide(plot, plot_show);
		showOrHide(embedded_raport, embedded_raport_show);
		showOrHide(element_start, element_start_show);
		showOrHide(element_end, element_end_show);
	}
</script>
{% endblock %}